<div id="ipython-notebook">
            <a class="interact-button" href="http://data8.berkeley.edu/hub/interact?repo=textbook&path=notebooks/married_couples.csv&path=notebooks/Permutation.ipynb">Interact</a>
            <div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Comparing-Two-Groups">Comparing Two Groups<a class="anchor-link" href="#Comparing-Two-Groups">¶</a></h2><p>The examples above investigate whether a sample appears to be chosen randomly from an underlying population. A similar line of reasoning can be used to determine whether two parts of a population are different. In particular, given two groups that differ in some distinguishing characteristic, we can investigate whether they are the same or different in another aspect.</p></div></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example:-Married-Couples-and-Umarried-Partners">Example: Married Couples and Umarried Partners<a class="anchor-link" href="#Example:-Married-Couples-and-Umarried-Partners">¶</a></h3><p>The methods that we have developed allow us to think inferentially about data from a variety of sources. Our next example is based on a study conducted in 2010 under the auspices of the National Center for Family and Marriage Research.</p>
<p>In the United States, the proportion of couples who live together but are not married has been rising in recent decades. The study involved a national random sample of over 1,000 heterosexual couples who were either married or living together but unmarried. One of the goals of the study was to compare the attitudes and experiences of the married and umarried couples.</p>
<p>The table below shows a subset of the data collected in the study. Each row corresponds to one person. The variables that we will examine in this section are:</p>
<ul>
<li>mar_status: 1=married, 2=unmarried</li>
<li>empl_status: employment status; categories described below</li>
<li>gender: 1=male, 2=female</li>
<li>age: Age in years</li>
</ul></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'empl_status'</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">,</span> <span class="p">]</span>
<span class="n">couples</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s">'married_couples.csv'</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
<span class="n">couples</span>
</pre></div></div></div>
<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>mar_status</th> <th>empl_status</th> <th>gender</th> <th>age</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1         </td> <td>1          </td> <td>1     </td> <td>51  </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1         </td> <td>1          </td> <td>2     </td> <td>53  </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1         </td> <td>1          </td> <td>1     </td> <td>57  </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1         </td> <td>1          </td> <td>2     </td> <td>57  </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1         </td> <td>1          </td> <td>1     </td> <td>60  </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1         </td> <td>1          </td> <td>2     </td> <td>57  </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1         </td> <td>2          </td> <td>1     </td> <td>62  </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1         </td> <td>1          </td> <td>2     </td> <td>59  </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1         </td> <td>7          </td> <td>1     </td> <td>53  </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1         </td> <td>5          </td> <td>2     </td> <td>61  </td>
        </tr>
    </tbody>
</table>
<p>... (2058 rows omitted)</p></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can improve the legibility of this table by converting numeric codes to text labels. The first two columns consist of the numerical codes assigned by the study to each person's marital status and employment status.</p>
<p>The <code>describe</code> function uses <code>np.choose</code>, a function that takes a sequences of indices and a sequence of labels. It returns a list that is the same length as the sequence of indices, but contains the label (from the sequence of labels) corresponding to each instance. It's useful for converting numeric codes into text.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">descriptions</span><span class="p">):</span>
    <span class="sd">"""Relabel a column of codes and add a column of descriptions"""</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">column</span> <span class="o">+</span> <span class="s">'_code'</span>
    <span class="n">couples</span><span class="o">.</span><span class="n">relabel</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
    <span class="n">couples</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">couples</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">descriptions</span><span class="p">)</span>
    
<span class="n">describe</span><span class="p">(</span><span class="s">'mar_status'</span><span class="p">,</span> <span class="p">[</span><span class="s">'married'</span><span class="p">,</span> <span class="s">'partner'</span><span class="p">])</span>
<span class="n">describe</span><span class="p">(</span><span class="s">'empl_status'</span><span class="p">,</span> <span class="p">[</span>
    <span class="s">'Working as paid employee'</span><span class="p">,</span>
    <span class="s">'Working, self-employed'</span><span class="p">,</span>
    <span class="s">'Not working - on a temporary layoff from a job'</span><span class="p">,</span>
    <span class="s">'Not working - looking for work'</span><span class="p">,</span>
    <span class="s">'Not working - retired'</span><span class="p">,</span>
    <span class="s">'Not working - disabled'</span><span class="p">,</span>
    <span class="s">'Not working - other'</span><span class="p">,</span>
<span class="p">])</span>
<span class="n">describe</span><span class="p">(</span><span class="s">'gender'</span><span class="p">,</span> <span class="p">[</span><span class="s">'male'</span><span class="p">,</span> <span class="s">'female'</span><span class="p">])</span>
<span class="n">couples</span><span class="p">[</span><span class="s">'count'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">couples</span>
</pre></div></div></div>
<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>mar_status_code</th> <th>empl_status_code</th> <th>gender_code</th> <th>age</th> <th>mar_status</th> <th>empl_status</th> <th>gender</th> <th>count</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1              </td> <td>1               </td> <td>1          </td> <td>51  </td> <td>married   </td> <td>Working as paid employee</td> <td>male  </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1              </td> <td>1               </td> <td>2          </td> <td>53  </td> <td>married   </td> <td>Working as paid employee</td> <td>female</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1              </td> <td>1               </td> <td>1          </td> <td>57  </td> <td>married   </td> <td>Working as paid employee</td> <td>male  </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1              </td> <td>1               </td> <td>2          </td> <td>57  </td> <td>married   </td> <td>Working as paid employee</td> <td>female</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1              </td> <td>1               </td> <td>1          </td> <td>60  </td> <td>married   </td> <td>Working as paid employee</td> <td>male  </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1              </td> <td>1               </td> <td>2          </td> <td>57  </td> <td>married   </td> <td>Working as paid employee</td> <td>female</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1              </td> <td>2               </td> <td>1          </td> <td>62  </td> <td>married   </td> <td>Working, self-employed  </td> <td>male  </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1              </td> <td>1               </td> <td>2          </td> <td>59  </td> <td>married   </td> <td>Working as paid employee</td> <td>female</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1              </td> <td>7               </td> <td>1          </td> <td>53  </td> <td>married   </td> <td>Not working - other     </td> <td>male  </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>1              </td> <td>5               </td> <td>2          </td> <td>61  </td> <td>married   </td> <td>Not working - retired   </td> <td>female</td> <td>1    </td>
        </tr>
    </tbody>
</table>
<p>... (2058 rows omitted)</p></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Above, the first four columns are unchanged except for their labels. The next three columns interpret the codes for marital status, employment status, and gender. The final column is always 1, indicating that each row corresponds to 1 person.</p>
<p>Let us consider just the males first. There are 742 married couples and 292 unmarried couples, and all couples in this study had one male and one female, making 1,034 males in all.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="c"># Separate tables for married and cohabiting unmarried couples</span>

<span class="n">married</span> <span class="o">=</span> <span class="n">couples</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'gender'</span><span class="p">,</span> <span class="s">'male'</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'married'</span><span class="p">)</span>
<span class="n">partner</span> <span class="o">=</span> <span class="n">couples</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'gender'</span><span class="p">,</span> <span class="s">'male'</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'partner'</span><span class="p">)</span>
</pre></div></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">married</span><span class="o">.</span><span class="n">num_rows</span>
</pre></div></div></div>
<div class="output_text output_subarea output_execute_result">
<pre>742</pre></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">partner</span><span class="o">.</span><span class="n">num_rows</span>
</pre></div></div></div>
<div class="output_text output_subarea output_execute_result">
<pre>292</pre></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Societal norms have changed over the decades, and there has been a gradual acceptance of couples living together without being married. Thus it is natural to expect that unmarried couples will in general consist of younger people than married couples. The histograms of the ages of the married and unmarried men show that this is indeed the case:</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="c"># Ages of married men</span>

<span class="n">married</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'age'</span><span class="p">)</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">normed</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
<span class="n">plots</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.045</span><span class="p">)</span> <span class="c"># Set the lower and upper bounds of the vertical axis</span>
</pre></div></div></div>
<div class="output_text output_subarea output_execute_result">
<pre>(0, 0.045)</pre></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_11_1.png"/></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="c"># Ages of cohabiting unmarried men</span>

<span class="n">partner</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'age'</span><span class="p">)</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">normed</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
<span class="n">plots</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.045</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_text output_subarea output_execute_result">
<pre>(0, 0.045)</pre></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_12_1.png"/></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The difference is even more marked when we compare the married and unmarried women. The <code>plots.ylim</code> call ensures that all four histograms have been drawn to the same scale, for ease of comparison.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">married</span> <span class="o">=</span> <span class="n">couples</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'gender'</span><span class="p">,</span> <span class="s">'female'</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'married'</span><span class="p">)</span>
<span class="n">partner</span> <span class="o">=</span> <span class="n">couples</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'gender'</span><span class="p">,</span> <span class="s">'female'</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'partner'</span><span class="p">)</span>
</pre></div></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="c"># Ages of married women</span>

<span class="n">married</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'age'</span><span class="p">)</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">normed</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
<span class="n">plots</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.045</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_text output_subarea output_execute_result">
<pre>(0, 0.045)</pre></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_15_1.png"/></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="c"># Ages of cohabiting unmarried women</span>

<span class="n">partner</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'age'</span><span class="p">)</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">normed</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
<span class="n">plots</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.045</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_text output_subarea output_execute_result">
<pre>(0, 0.045)</pre></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_16_1.png"/></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If married couples are in general older, they might differ from unmarried couples in other ways as well. For example, they might tend to be more wealthy or more educated than unmarried couples. Since both of those variables are associated with employment, the next variable that we will examine will be the employment status of the men.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">males</span> <span class="o">=</span> <span class="n">couples</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'gender'</span><span class="p">,</span> <span class="s">'male'</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'empl_status'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">])</span>
<span class="n">males</span>
</pre></div></div></div>
<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>mar_status</th> <th>empl_status</th> <th>count</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>married   </td> <td>Working as paid employee                      </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Working as paid employee                      </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Working as paid employee                      </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Working, self-employed                        </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Not working - other                           </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Not working - on a temporary layoff from a job</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Not working - disabled                        </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Working as paid employee                      </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Working as paid employee                      </td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Not working - retired                         </td> <td>1    </td>
        </tr>
    </tbody>
</table>
<p>... (1024 rows omitted)</p></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Contingency-Tables">Contingency Tables<a class="anchor-link" href="#Contingency-Tables">¶</a></h3><p>The <code>pivot</code> method operates on a table in which each row is classified according to two variables (marital status and employment status, in this example). It returns what is known as a <em>contingency table</em> of the counts. A contingency table consists of a cell for each pair of categories that can be formed by taking one category of the first variable and one category of the second. In the cell it displays the count of rows that match that pair of categories.</p>
<p>For example, the table below shows that there were 28 men who were married and not working but looking for work. There were 171 men who were not married and were working as paid employees. And so on.</p>
<p>The <code>pivot</code> method takes as its first argument the name of the column that contains values to be used as column labels. Each unique value in this input column appears as a column in the contingency table.  The second argument is the name of the column that contains values to be used as row labels. Each unique value in this input column appears in a separate row as the first entry. The third argument is the source of the values in the contingency table. In this case, counts are used and they are aggregated by summing.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">employed</span> <span class="o">=</span> <span class="n">males</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'empl_status'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">,</span> <span class="nb">sum</span><span class="p">)</span>
<span class="n">employed</span>
</pre></div></div></div>
<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>empl_status</th> <th>married count</th> <th>partner count</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Not working - disabled                        </td> <td>44           </td> <td>20           </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Not working - looking for work                </td> <td>28           </td> <td>33           </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Not working - on a temporary layoff from a job</td> <td>15           </td> <td>8            </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Not working - other                           </td> <td>16           </td> <td>9            </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Not working - retired                         </td> <td>44           </td> <td>4            </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working as paid employee                      </td> <td>513          </td> <td>171          </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working, self-employed                        </td> <td>82           </td> <td>47           </td>
        </tr>
    </tbody>
</table></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">employed</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">'empl_status'</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div></div></div>
<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>married count</th> <th>partner count</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>742          </td> <td>292          </td>
        </tr>
    </tbody>
</table></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Because the total number of married couples in the sample is greater than the number of unmarried couples, the counts in the different categories are not directly comparable. So we convert them into proportions, displayed in the last two columns of the table below. The <code>married</code> column shows the distribution of employment status of the married men in the sample. The <code>partner</code> column shows the distribution of the employment status of the unmarried men.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">employed</span><span class="p">[</span><span class="s">'married'</span><span class="p">]</span> <span class="o">=</span> <span class="n">employed</span><span class="p">[</span><span class="s">'married count'</span><span class="p">]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">employed</span><span class="p">[</span><span class="s">'married count'</span><span class="p">])</span>
<span class="n">employed</span><span class="p">[</span><span class="s">'partner'</span><span class="p">]</span> <span class="o">=</span> <span class="n">employed</span><span class="p">[</span><span class="s">'partner count'</span><span class="p">]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">employed</span><span class="p">[</span><span class="s">'partner count'</span><span class="p">])</span>
<span class="n">employed</span>
</pre></div></div></div>
<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>empl_status</th> <th>married count</th> <th>partner count</th> <th>married</th> <th>partner</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Not working - disabled                        </td> <td>44           </td> <td>20           </td> <td>0.0592992</td> <td>0.0684932</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Not working - looking for work                </td> <td>28           </td> <td>33           </td> <td>0.0377358</td> <td>0.113014 </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Not working - on a temporary layoff from a job</td> <td>15           </td> <td>8            </td> <td>0.0202156</td> <td>0.0273973</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Not working - other                           </td> <td>16           </td> <td>9            </td> <td>0.0215633</td> <td>0.0308219</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Not working - retired                         </td> <td>44           </td> <td>4            </td> <td>0.0592992</td> <td>0.0136986</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working as paid employee                      </td> <td>513          </td> <td>171          </td> <td>0.691375 </td> <td>0.585616 </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working, self-employed                        </td> <td>82           </td> <td>47           </td> <td>0.110512 </td> <td>0.160959 </td>
        </tr>
    </tbody>
</table></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The two distributions look somewhat different from each other, as can be seen more clearly in the bar graphs below. It appears that a larger proportion of the married men work as paid employees, whereas a larger proportion of unmarried men are not working but are looking for work.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">employed</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s">'empl_status'</span><span class="p">,</span> <span class="s">'married'</span><span class="p">,</span> <span class="s">'partner'</span><span class="p">])</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="s">'empl_status'</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_25_0.png"/></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The difference in the two bar graphs raises the question of whether the differences are due to randomness in the sampling, or whether the distribution of employment status is indeed different for married men in the U.S. than it is for unmarried men who live with their partners. Remember that the data that we have are from a sample of just 1,034 couples; we do not know the distribution of employment status of men in the entire country.</p>
<p>We can answer the question by performing a statistical test of hypotheses. Let us use the terminolgoy that we developed for this in the previous section.</p></div></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Null hypothesis.</strong> In the United States, the distribution of employment status among married men is the same as among unmarried men who live with their partners. The difference between the two samples is due to chance.</p>
<p><strong>Alternative hypothesis.</strong> In the United States, the distributions of the employment status of the two groups of men are different.</p>
<p>As our <strong>test statistic</strong>, we will use the total variation distance between the two distributions. Because employment status is a categorical variable, there is no question of computing summary statistics such as means. By using the total variation distance, we can compare the entire distributions, not just summaries.</p>
<p>The observed value of the test statistic is about 0.15:</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="c"># TVD between the two distributions</span>

<span class="n">observed_tvd</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">employed</span><span class="p">[</span><span class="s">'married'</span><span class="p">]</span><span class="o">-</span><span class="n">employed</span><span class="p">[</span><span class="s">'partner'</span><span class="p">]))</span>
<span class="n">observed_tvd</span>
</pre></div></div></div>
<div class="output_text output_subarea output_execute_result">
<pre>0.15135878595428867</pre></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="The-Null-Hypotheis-and-Random-Permutations">The Null Hypotheis and Random Permutations<a class="anchor-link" href="#The-Null-Hypotheis-and-Random-Permutations">¶</a></h3><p>The next step is important but subtle. In order to compare this observed value of the total variation distance with what is predicted by the null hypothesis, we need the probability distribution of the total variation distance under the null hypothesis. But  the probability distribution of the total variation distance is quite daunting to derive by mathematics. So we will simulate numerous repetitions of the sampling procedure under the null hypothesis.</p>
<p>With just one sample at hand, and no further knowledge of the distribution of employment status among women in the U.S., how can we go about replicating the sampling procedure? The key is to note that <em>if</em> marital status and employment status were not connected in any way, then we could replicate the sampling process by replacing each oman's employment status by a randomly picked employment status from among all the men, married or unmarried. Doing this for all the men is equivalent to permuting the entire column containing employment status, while leaving the marital status column unchanged.</p>
<p>Thus, under the null hypothesis, we can replicate the sampling process by assigning to each married man an employment status chosen at random without replacement from the entries in <code>empl_status</code>. Since the first 742 rows of <code>males</code> correspond to the married men, we can do the replication by simply permuting the entire <code>empl_status</code> column and leaving everything else unchanged.</p>
<p>Let's implement this plan. First, we will shuffle the column <code>empl_status</code> using the <code>sample</code> method, which just shuffles all rows when provided with no arguments.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="c"># Randomly permute the employment status of all men</span>

<span class="n">shuffled</span> <span class="o">=</span> <span class="n">males</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'empl_status'</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">shuffled</span>
</pre></div></div></div>
<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>empl_status</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Working as paid employee</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working as paid employee</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working as paid employee</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working as paid employee</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working as paid employee</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working as paid employee</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working as paid employee</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working as paid employee</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working as paid employee</td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working as paid employee</td>
        </tr>
    </tbody>
</table>
<p>... (1024 rows omitted)</p></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first two columns of the table below are taken from the original sample. The third has been created by randomly permuting the original <code>empl_status</code> column.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="c"># Construct a table in which employment status has been shuffled</span>

<span class="n">males_with_shuffled_empl</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">males</span><span class="p">[</span><span class="s">'mar_status'</span><span class="p">],</span> <span class="n">males</span><span class="p">[</span><span class="s">'empl_status'</span><span class="p">],</span> <span class="n">shuffled</span><span class="p">[</span><span class="s">'empl_status'</span><span class="p">]],</span> 
                                 <span class="p">[</span><span class="s">'mar_status'</span><span class="p">,</span>        <span class="s">'empl_status'</span><span class="p">,</span>        <span class="s">'empl_status_shuffled'</span><span class="p">])</span>
<span class="n">males_with_shuffled_empl</span><span class="p">[</span><span class="s">'count'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">males_with_shuffled_empl</span>
</pre></div></div></div>
<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>mar_status</th> <th>empl_status</th> <th>empl_status_shuffled</th> <th>count</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>married   </td> <td>Working as paid employee                      </td> <td>Working as paid employee</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Working as paid employee                      </td> <td>Working as paid employee</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Working as paid employee                      </td> <td>Working as paid employee</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Working, self-employed                        </td> <td>Working as paid employee</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Not working - other                           </td> <td>Working as paid employee</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Not working - on a temporary layoff from a job</td> <td>Working as paid employee</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Not working - disabled                        </td> <td>Working as paid employee</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Working as paid employee                      </td> <td>Working as paid employee</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Working as paid employee                      </td> <td>Working as paid employee</td> <td>1    </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>married   </td> <td>Not working - retired                         </td> <td>Working as paid employee</td> <td>1    </td>
        </tr>
    </tbody>
</table>
<p>... (1024 rows omitted)</p></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once again, the <code>pivot</code> method computes the contingency table, which allows us to calculate the total variation distance between the distributions of the two groups of men.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">employed_shuffled</span> <span class="o">=</span> <span class="n">males_with_shuffled_empl</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'empl_status'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">,</span> <span class="nb">sum</span><span class="p">)</span>
<span class="n">employed_shuffled</span>
</pre></div></div></div>
<div class="output_html rendered_html output_subarea output_execute_result">
<table border="1" class="dataframe">
    <thead>
        <tr>
            <th>empl_status</th> <th>married count</th> <th>partner count</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Not working - disabled                        </td> <td>44           </td> <td>20           </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Not working - looking for work                </td> <td>28           </td> <td>33           </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Not working - on a temporary layoff from a job</td> <td>15           </td> <td>8            </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Not working - other                           </td> <td>16           </td> <td>9            </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Not working - retired                         </td> <td>44           </td> <td>4            </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working as paid employee                      </td> <td>513          </td> <td>171          </td>
        </tr>
    </tbody>
        <tbody><tr>
            <td>Working, self-employed                        </td> <td>82           </td> <td>47           </td>
        </tr>
    </tbody>
</table></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="c"># TVD between the two distributions of the permuted table</span>
<span class="n">married</span> <span class="o">=</span> <span class="n">employed_shuffled</span><span class="p">[</span><span class="s">'married count'</span><span class="p">]</span>
<span class="n">partner</span> <span class="o">=</span> <span class="n">employed_shuffled</span><span class="p">[</span><span class="s">'partner count'</span><span class="p">]</span>
<span class="mf">0.5</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">married</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">married</span><span class="p">)</span><span class="o">-</span><span class="n">partner</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">partner</span><span class="p">)))</span>
</pre></div></div></div>
<div class="output_text output_subarea output_execute_result">
<pre>0.15135878595428867</pre></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This total variation distance was computed based on the null hypothesis that the distributions of employment status for the two groups of men are the same. You can see that it is noticeably smaller than the observed value of the total variation distance (0.15) between the two groups in our original sample.</p>
<h3 id="A-Permutation-Test">A Permutation Test<a class="anchor-link" href="#A-Permutation-Test">¶</a></h3><p>Could that just be due to chance variation? We will only know if we run many more replications, by randomly permuting the <code>empl_status</code> column repeatedly. This method of testing is known as a <strong>permutation test</strong>.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="c"># Put it all together in a for loop to perform a permutation test</span>

<span class="n">repetitions</span><span class="o">=</span><span class="mi">200</span>

<span class="n">tvds</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">repetitions</span><span class="p">):</span>
    <span class="c"># Construct a permuted table</span>
    <span class="n">shuffled</span> <span class="o">=</span> <span class="n">males</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">'empl_status'</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">males</span><span class="p">[</span><span class="s">'mar_status'</span><span class="p">],</span> <span class="n">shuffled</span><span class="p">[</span><span class="s">'empl_status'</span><span class="p">]],</span> 
                     <span class="p">[</span><span class="s">'mar_status'</span><span class="p">,</span>        <span class="s">'empl_status'</span><span class="p">])</span>
    <span class="n">combined</span><span class="p">[</span><span class="s">'count'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">employed_shuffled</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'empl_status'</span><span class="p">,</span> <span class="s">'count'</span><span class="p">,</span> <span class="nb">sum</span><span class="p">)</span>
    
    <span class="c"># Compute TVD</span>
    <span class="n">married</span> <span class="o">=</span> <span class="n">employed_shuffled</span><span class="p">[</span><span class="s">'married count'</span><span class="p">]</span>
    <span class="n">partner</span> <span class="o">=</span> <span class="n">employed_shuffled</span><span class="p">[</span><span class="s">'partner count'</span><span class="p">]</span>
    <span class="n">tvd</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">married</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">married</span><span class="p">)</span><span class="o">-</span><span class="n">partner</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">partner</span><span class="p">)))</span>
    <span class="n">tvds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tvd</span><span class="p">)</span>

<span class="n">Table</span><span class="p">([</span><span class="n">tvds</span><span class="p">],</span> <span class="p">[</span><span class="s">'Empirical distribution of TVDs'</span><span class="p">])</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span><span class="n">normed</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_37_0.png"/></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The figure above is the <strong>empirical distribution of the total variation distance</strong> between the distributions of the employment status of married and unmarried men, under the null hypothesis. <strong>The observed test statistic of 0.15 is quite far in the tail, and so the chance of observing such an extreme value under the null hypothesis is close to 0</strong>.</p>
<p>This chance is called a "P-value" in a hypothesis test. The P-value is the chance that our test statistic (TVD) would come out at least as extreme as the observed value (0.15 or greater) under the null hypothesis.</p></div></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can directly compute an empirical approximation to the P-value using the <code>tvds</code> we collected during the permutation test. The <code>np.count_nonzero</code> function takes a sequence of numbers and returns how many of them are not zero. When passed a list of <code>True</code> and <code>False</code> values, it returns the number that are <code>True</code>.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">p_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">tvds</span> <span class="o">&gt;=</span> <span class="n">observed_tvd</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">tvds</span><span class="p">)</span>
<span class="n">p_value</span>
</pre></div></div></div>
<div class="output_text output_subarea output_execute_result">
<pre>0.0</pre></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We call this <code>p_value</code> an empirical approximation because it is not the true chance of observing a TVD at least as large as 0.15. Instead, it is the particular result we happened to compute when shuffling randomly 200 times. Computing the true value would require us to consider all possible outcomes of shuffling (which is large) instead of just 200 random shuffles. Were we to consider all cases, there would be some with a more extreme TVD, and so the true P-value is greater than zero but not by much.</p>
<p>A low P-value constitutes <strong>evidence in favor of the alternative hypothesis</strong>. The data support the hypothesis that in the United States, the distribution of the employment status of married men is not the same as that of unmarried men who live with their partners.</p>
<p>In this example, our empirical estimate from sampling tells us all the information we need to draw conclusions from the data; the observed statistic is very unlikely under the null hypothesis. Precisely how unlikely often doesn't matter. Permutation tests of this form are indeed quite common in practice because they make few assumptions about the underlying population and are straightforward to perform and interpret.</p></div></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Generalizing-Our-Hypothesis-Test">Generalizing Our Hypothesis Test<a class="anchor-link" href="#Generalizing-Our-Hypothesis-Test">¶</a></h3><p>The example above includes a substantial amount of code in order to investigate the relationship between two characteristics (marital status and employment status) for a particular subset of the surveyed population (males). Suppose we would like to investigate different characteristics or a different population. How can we reuse the code we have written so far in order to explore more relationships?</p>
<p>Functions allow us to generalize both the statistics we compute and the computational process of performing a permutation test. We can begin with a generalized computation of total variation distance between the distribution of any column of values (such as employment status) when separated into any two conditions (such as marital status) for a collection of data described by any table. Our implementation includes the same statements as we used above, but uses generic names that are specified by the final function call.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="c"># TVD between any two conditions</span>

<span class="k">def</span> <span class="nf">tvd</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="sd">"""Compute the total variation distance between counts of values under two conditions.</span>
<span class="sd">    </span>
<span class="sd">    t          (Table) -- a table</span>
<span class="sd">    conditions (str)   -- a column label in t</span>
<span class="sd">    values     (str)   -- a column label in t</span>
<span class="sd">    """</span>
    <span class="n">t</span><span class="p">[</span><span class="s">'count'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="s">'count'</span><span class="p">,</span> <span class="nb">sum</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>

<span class="n">tvd</span><span class="p">(</span><span class="n">males</span><span class="p">,</span> <span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'empl_status'</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_text output_subarea output_execute_result">
<pre>0.15135878595428867</pre></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we can write a function that performs a permutation test using this <code>tvd</code> function to compute the same statistic on shuffled variants of any table. It's worth reading through this implementation to understand its details.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">def</span> <span class="nf">permutation_tvd</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="sd">"""Perform a permutation test to estimate the likelihood of the observed</span>
<span class="sd">    total variation distance (our test statistic) between counts of values</span>
<span class="sd">    under the null hypothesis that the distribution of values for two </span>
<span class="sd">    conditions is the same.</span>
<span class="sd">    """</span>
    <span class="n">repetitions</span><span class="o">=</span><span class="mi">200</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">repetitions</span><span class="p">):</span>
        <span class="n">shuffled</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">original</span><span class="p">[</span><span class="n">conditions</span><span class="p">],</span> <span class="n">shuffled</span><span class="p">[</span><span class="n">values</span><span class="p">]],</span> 
                         <span class="p">[</span><span class="n">conditions</span><span class="p">,</span> <span class="n">values</span><span class="p">])</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tvd</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>

    <span class="n">observation</span> <span class="o">=</span> <span class="n">tvd</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">stats</span> <span class="o">&gt;=</span> <span class="n">observation</span><span class="p">)</span> <span class="o">/</span> <span class="n">repetitions</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s">"Observation:"</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s">"Empirical P-value:"</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span>
    <span class="n">Table</span><span class="p">([</span><span class="n">stats</span><span class="p">],</span> <span class="p">[</span><span class="s">'Empirical distribution'</span><span class="p">])</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">normed</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
</pre></div></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">permutation_tvd</span><span class="p">(</span><span class="n">males</span><span class="p">,</span> <span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'empl_status'</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Observation: 0.151358785954
Empirical P-value: 0.0
</pre></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_46_1.png"/></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have generalized our permutation test, we can apply it to other hypotheses. For example, we can compare the distribution over the employment status of women, grouping them by their marital status. In the case of men we found a difference, but what about with women? First, we can visualize the two distributions.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">def</span> <span class="nf">compare_bar</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="sd">"""Overlay histograms of values for two conditions."""</span>
    <span class="n">t</span><span class="p">[</span><span class="s">'count'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="s">'count'</span><span class="p">,</span> <span class="nb">sum</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">column_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">e</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">label</span><span class="p">])</span> <span class="c"># Normalize each column of counts</span>
    <span class="n">e</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

<span class="n">compare_bar</span><span class="p">(</span><span class="n">couples</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'gender'</span><span class="p">,</span> <span class="s">'female'</span><span class="p">),</span> <span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'empl_status'</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_48_0.png"/></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A glance at the two columns of proportions shows that the two distributions are different. The difference in the category "Not working – other" is particularly striking: about 22% of the married women are in this cateogory, compared to only about 8% of the unmarried women. There are several reasons for this difference. For example, the percent of homemakers is greater among married women than among unmarried women, possibly because married women are more likely to be "stay-at-home" mothers of young children. The difference could also be generational: as we saw earlier, the married couples are older than the unmarried partners, and older women are less likely to be in the workforce than younger women.</p>
<p>Let's review our reasoning about hypothesis testing. We have to consider the possibility that the difference could simply be the result of chance variation. Remember that our data are only from a random sample of couples. We do not have data for all the couples in the United States.</p>
<p>To test this, we set up null and alternative hypotheses. When setting up a hypothesis, the null in particular, it is important to be clear: exactly what are the unknowns about which you hypothesizing? In our example, the sample is entirely known, and the distributions of employment status in the two groups of women are simply different – the difference is visible in the data. The unknowns are the distributions of employment status among married and unmarried women <em>in the United States</em>, the population from which the sample was drawn. It is those distributions, in the population, about which we will form the competing hypotheses.</p></div></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Null hypothesis</strong>: In the U.S., the distribution of employment status is the same for married women as for unmarried women living with their partners. The difference in the sample is due to chance.</p>
<p><strong>Alternative hypothesis</strong>: In the U.S., the distributions of employment status among married and unmarried cohabitating women are different.</p>
<p>As with the males, the null hypothesis can be rejected because if it were true, something very unlikely occurred in this sample.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">permutation_tvd</span><span class="p">(</span><span class="n">couples</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">'gender'</span><span class="p">,</span> <span class="s">'female'</span><span class="p">),</span> <span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'empl_status'</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Observation: 0.195343942695
Empirical P-value: 0.0
</pre></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_51_1.png"/></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Age:-A-Quantitative-Variable">Age: A Quantitative Variable<a class="anchor-link" href="#Age:-A-Quantitative-Variable">¶</a></h3><p>Next, we can test the null hypothesis that the distributions in ages between married and cohabitating individuals are the same. Age is a quantitative variable — everyone has a different age. However, in our dataset, ages have been binned already into yearly categories.</p>
<p>It is perhaps no surprise that the empirical P-value is 0 (below); the idea that a couple would live together without being married has become more acceptable over time, and so we might expect that cohabitating couples are younger.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">permutation_tvd</span><span class="p">(</span><span class="n">couples</span><span class="p">,</span> <span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Observation: 0.300760624746
Empirical P-value: 0.0
</pre></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_53_1.png"/></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Looking at the distributions in ages confirms the result of this permutation test; the distributions simply look quite different. Here's a function that compares the distribution of values for two conditions. When called on <code>'mar_status'</code> as the <code>conditions</code>, we compare the distributions of ages for <code>mar_status=1</code> (married) and <code>mar_status=2</code> (cohabitating).</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="sd">"""Overlay histograms of values for two conditions."""</span>
    <span class="n">t</span><span class="p">[</span><span class="s">'count'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="s">'count'</span><span class="p">,</span> <span class="nb">sum</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">column_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">e</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">label</span><span class="p">])</span> <span class="c"># Normalize each column of counts</span>
    <span class="n">e</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">counts</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

<span class="n">compare</span><span class="p">(</span><span class="n">couples</span><span class="p">,</span> <span class="s">'mar_status'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_55_0.png"/></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>What about the relationship of gender and age? Is there a difference in these distributions?</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">compare</span><span class="p">(</span><span class="n">couples</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_57_0.png"/></div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this case, the women (gender=2) in the surveyed population of couples have an age distribution that skews a bit younger. Would this observed difference be a typical result of sampling if both the distributions of men and women in couples were in fact the same? According to our <code>permutation_tvd</code> test, the total variation distance between ages of these two groups is quite typical.</p></div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">permutation_tvd</span><span class="p">(</span><span class="n">couples</span><span class="p">,</span> <span class="s">'gender'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">)</span>
</pre></div></div></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Observation: 0.115087040619
Empirical P-value: 0.545
</pre></div>
<div class="output_png output_subarea ">
<img src="../notebooks-images/Permutation_59_1.png"/></div></div>